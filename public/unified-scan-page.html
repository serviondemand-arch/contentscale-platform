<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ContentScale - AI-Powered SEO Content Analyzer</title>
  <meta name="description" content="Advanced SEO content analysis with hybrid AI. Get deterministic scoring + Claude AI validation for the most accurate SEO recommendations.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .calc-breakdown { display: none; padding: 12px; background: #1f2937; border-radius: 8px; margin-top: 8px; }
    .calc-breakdown.open { display: block; }
    .score-formula { font-family: 'Courier New', monospace; background: #111827; padding: 8px; border-radius: 4px; font-size: 13px; }
    .recommendation { cursor: pointer; transition: all 0.2s; }
    .recommendation:hover { transform: translateX(4px); }
    .hybrid-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .hybrid-badge.deterministic { background: #10b981; color: white; }
    .hybrid-badge.ai-validated { background: #8b5cf6; color: white; }
    .adjustment-card { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px; margin: 8px 0; }
    .edge-case-card { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 4px; margin: 8px 0; }
    .toggle-switch { position: relative; width: 48px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #6b7280; transition: .4s; border-radius: 24px; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #8b5cf6; }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
    .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #8b5cf6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tooltip { position: relative; display: inline-block; cursor: help; }
    .tooltip .tooltiptext { visibility: hidden; width: 280px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 6px; padding: 12px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -140px; opacity: 0; transition: opacity 0.3s; font-size: 12px; border: 1px solid #4b5563; }
    .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .info-icon { display: inline-block; width: 16px; height: 16px; background: #6b7280; color: white; border-radius: 50%; text-align: center; line-height: 16px; font-size: 11px; font-weight: bold; margin-left: 4px; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8">
  <div class="max-w-5xl mx-auto">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-purple-900 via-blue-900 to-purple-900 rounded-xl p-8 mb-8 border border-purple-500">
      <div class="text-center mb-6">
        <h1 class="text-5xl font-bold mb-3 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
          ContentScale AI SEO Analyzer
        </h1>
        <p class="text-xl text-gray-300 mb-2">The Most Advanced SEO Scoring System</p>
        <p class="text-sm text-gray-400">Hybrid AI: Reliable Formulas + Intelligent Validation</p>
      </div>

      <!-- Value Propositions -->
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 text-center">
          <div class="text-3xl mb-2">üéØ</div>
          <div class="font-semibold text-white mb-1">100% Reliable</div>
          <div class="text-xs text-gray-400">Deterministic core - always same result for same content</div>
        </div>
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 text-center">
          <div class="text-3xl mb-2">ü§ñ</div>
          <div class="font-semibold text-white mb-1">AI-Powered Insights</div>
          <div class="text-xs text-gray-400">Claude AI spots edge cases and provides educational recommendations</div>
        </div>
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 text-center">
          <div class="text-3xl mb-2">üìö</div>
          <div class="font-semibold text-white mb-1">Learn & Improve</div>
          <div class="text-xs text-gray-400">Understand WHY it matters and HOW to implement fixes</div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 mb-6">
        <h3 class="font-semibold text-white mb-3 text-center">‚ö° How It Works (4 Layers)</h3>
        <div class="grid md:grid-cols-4 gap-3 text-xs">
          <div class="text-center">
            <div class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center mx-auto mb-2 font-bold">1</div>
            <div class="font-semibold text-green-400 mb-1">Backend Scan</div>
            <div class="text-gray-400">Puppeteer analyzes 100+ metrics</div>
          </div>
          <div class="text-center">
            <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mx-auto mb-2 font-bold">2</div>
            <div class="font-semibold text-blue-400 mb-1">Score Formulas</div>
            <div class="text-gray-400">GRAAF + CRAFT + Technical = 100pts</div>
          </div>
          <div class="text-center">
            <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center mx-auto mb-2 font-bold">3</div>
            <div class="font-semibold text-purple-400 mb-1">AI Validation</div>
            <div class="text-gray-400">Claude spots quality issues</div>
          </div>
          <div class="text-center">
            <div class="bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center mx-auto mb-2 font-bold">4</div>
            <div class="font-semibold text-pink-400 mb-1">Smart Advice</div>
            <div class="text-gray-400">WHY, HOW, WHAT for each fix</div>
          </div>
        </div>
      </div>

      <!-- AI Mode Selection -->
      <div class="bg-gradient-to-r from-purple-800 to-blue-800 rounded-lg p-5 border border-purple-400">
        <div class="text-center mb-4">
          <h3 class="font-bold text-white text-lg mb-2">üéì Choose Your Analysis Mode</h3>
          <p class="text-sm text-gray-300">We recommend <span class="text-purple-300 font-semibold">AI Mode</span> for the best experience</p>
        </div>

        <!-- Mode Comparison -->
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <!-- Basic Mode -->
          <div class="bg-gray-800 bg-opacity-70 rounded-lg p-4 border border-gray-600">
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="font-semibold text-white">‚ö° Basic Mode</div>
                <div class="text-xs text-gray-400">Formulas only</div>
              </div>
              <div class="text-green-400 font-bold">FREE</div>
            </div>
            <div class="space-y-2 text-xs">
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span class="text-gray-300">Score calculation (0-100)</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span class="text-gray-300">Potential score (formulas)</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span class="text-gray-300">Basic recommendations</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-gray-600">‚úó</span>
                <span class="text-gray-500">Edge case detection</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-gray-600">‚úó</span>
                <span class="text-gray-500">Educational WHY/HOW</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-gray-600">‚úó</span>
                <span class="text-gray-500">AI-era SEO insights</span>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-700">
              <div class="text-xs text-gray-400">
                <span class="font-semibold">Speed:</span> ~3 sec<br>
                <span class="font-semibold">Best for:</span> Quick check
              </div>
            </div>
          </div>

          <!-- AI Mode (RECOMMENDED) -->
          <div class="bg-gradient-to-br from-purple-900 to-blue-900 rounded-lg p-4 border-2 border-purple-400 relative">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
              <span class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                ‚≠ê RECOMMENDED
              </span>
            </div>
            <div class="flex items-center justify-between mb-3 mt-2">
              <div>
                <div class="font-semibold text-white">ü§ñ AI Mode</div>
                <div class="text-xs text-purple-300">Formulas + Intelligence</div>
              </div>
              <div class="text-purple-300 font-bold text-sm">BEST</div>
            </div>
            <div class="space-y-2 text-xs">
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span class="text-gray-200 font-semibold">Everything from Basic Mode</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-purple-400">‚úì</span>
                <span class="text-gray-200">AI validation (edge cases)</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-purple-400">‚úì</span>
                <span class="text-gray-200">Educational explanations</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-purple-400">‚úì</span>
                <span class="text-gray-200">WHY, HOW, WHAT for each fix</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-purple-400">‚úì</span>
                <span class="text-gray-200">AI-era SEO insights</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-purple-400">‚úì</span>
                <span class="text-gray-200">Priority ranking (effort/impact)</span>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-purple-700">
              <div class="text-xs text-gray-300">
                <span class="font-semibold">Speed:</span> ~10 sec<br>
                <span class="font-semibold">Best for:</span> Deep analysis + learning
              </div>
            </div>
          </div>
        </div>

        <!-- Toggle with Labels -->
        <div class="flex items-center justify-center gap-4 bg-gray-900 bg-opacity-50 rounded-lg p-4">
          <div class="text-center">
            <div class="text-sm font-semibold mb-1">
              <span id="currentMode" class="text-purple-400">ü§ñ AI Mode</span>
            </div>
            <div class="text-xs text-gray-400" id="modeDescription">
              Best experience: edge cases + educational tips
            </div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="claudeToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="mt-3 text-center">
          <p class="text-xs text-gray-400">
            üí° <span class="text-purple-300">Tip:</span> Start with AI Mode for the most complete analysis. 
            You can always switch to Basic Mode if you just want a quick score check.
          </p>
        </div>
      </div>
    </div>

    <!-- Scan Form -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
      <h2 class="text-xl font-bold mb-4">üîç Scan Your Content</h2>
      <div class="flex gap-3">
        <input 
          type="text" 
          id="urlInput" 
          placeholder="https://example.com/your-article"
          class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
        >
        <button 
          onclick="scanURL()"
          class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 px-8 py-3 rounded-lg font-semibold transition"
        >
          Scan Now
        </button>
      </div>
      
      <div class="mt-4 flex items-center justify-between">
        <div class="text-xs text-gray-400">
          <span class="text-gray-500">üí° Example:</span>
          <button 
            onclick="document.getElementById('urlInput').value='https://contentscale.site'; scanURL();"
            class="text-purple-400 hover:text-purple-300 underline ml-1"
          >
            Scan ContentScale.site
          </button>
        </div>
        <div class="text-xs text-gray-500">
          ‚ö° Analysis takes ~10 seconds (AI Mode)
        </div>
      </div>
      
      <div id="loadingIndicator" class="hidden mt-4 text-center">
        <div class="inline-flex items-center gap-3">
          <div class="loading-spinner"></div>
          <span class="text-gray-400" id="loadingText">Scanning content...</span>
        </div>
      </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
      <!-- Score Overview -->
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg p-6 mb-6 shadow-lg border border-gray-700">
        <h2 class="text-2xl font-bold mb-4">üìä Your SEO Score</h2>
        
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <!-- Current Score -->
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-2 flex items-center justify-center gap-1">
              Current Score
              <div class="tooltip">
                <span class="info-icon">i</span>
                <span class="tooltiptext">
                  <strong>Current Score</strong><br>
                  Backend analyzes 100+ metrics:<br>
                  ‚Ä¢ GRAAF: 50pts (SEO fundamentals)<br>
                  ‚Ä¢ CRAFT: 30pts (Content quality)<br>
                  ‚Ä¢ Technical: 20pts (Schema, meta, mobile)<br>
                  <em>100% deterministic - always same result.</em>
                </span>
              </div>
            </div>
            <div class="text-4xl font-bold text-yellow-400" id="currentScore">--</div>
            <div class="text-xs text-gray-500 mt-1">
              <span class="hybrid-badge deterministic">Backend</span>
            </div>
          </div>
          
          <!-- Deterministic Potential -->
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-2 flex items-center justify-center gap-1">
              Calculated Potential
              <div class="tooltip">
                <span class="info-icon">i</span>
                <span class="tooltiptext">
                  <strong>Calculated Potential</strong><br>
                  Exact calculation with formulas:<br>
                  ‚Ä¢ Missing schema ‚Üí +4pts<br>
                  ‚Ä¢ Missing meta ‚Üí +1-2pts<br>
                  ‚Ä¢ Missing mobile/FAQ ‚Üí +2-4pts<br>
                  <em>Pure math - what you CAN achieve with quick fixes.</em>
                </span>
              </div>
            </div>
            <div class="text-4xl font-bold text-blue-400" id="deterministicPotential">--</div>
            <div class="text-xs text-gray-500 mt-1">
              <span class="hybrid-badge deterministic">Formulas</span>
            </div>
          </div>
          
          <!-- AI-Validated Potential -->
          <div class="bg-gray-800 rounded-lg p-4 text-center border-2 border-purple-500">
            <div class="text-sm text-gray-400 mb-2 flex items-center justify-center gap-1">
              AI-Validated Potential
              <div class="tooltip">
                <span class="info-icon">i</span>
                <span class="tooltiptext">
                  <strong>AI-Validated Potential</strong><br>
                  Claude AI validates the calculation:<br>
                  ‚Ä¢ FAQ answers too short?<br>
                  ‚Ä¢ Alt texts without keywords?<br>
                  ‚Ä¢ Expert quotes without attribution?<br>
                  <em>Can deviate -2 to +2 pts if Claude finds quality issues.</em>
                </span>
              </div>
            </div>
            <div class="text-4xl font-bold text-purple-400" id="validatedPotential">--</div>
            <div class="text-xs text-gray-500 mt-1">
              <span class="hybrid-badge ai-validated">Claude AI</span>
            </div>
          </div>
        </div>

        <!-- Validation Status -->
        <div id="validationStatus" class="hidden"></div>
        
        <!-- Target Message -->
        <div id="targetMessage" class="text-center pt-3 border-t border-gray-700"></div>
      </div>

      <!-- Score Breakdown (Expandable) -->
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">üìà Score Breakdown (Click to Expand)</h3>
        <div id="scoreBreakdown"></div>
      </div>

      <!-- AI Validation Insights (if enabled) -->
      <div id="aiInsights" class="hidden bg-gradient-to-r from-purple-900 to-blue-900 rounded-lg p-6 mb-6 border border-purple-500">
        <h3 class="text-xl font-bold mb-4">ü§ñ AI Validation Insights</h3>
        
        <!-- Adjustments -->
        <div id="adjustmentsContainer" class="hidden mb-4">
          <h4 class="font-semibold mb-2">‚öñÔ∏è Score Adjustments:</h4>
          <div id="adjustmentsList"></div>
        </div>
        
        <!-- Edge Cases -->
        <div id="edgeCasesContainer" class="hidden mb-4">
          <h4 class="font-semibold mb-2">üîç Edge Cases Detected:</h4>
          <div id="edgeCasesList"></div>
        </div>
      </div>

      <!-- Priority Recommendations -->
      <div class="bg-gradient-to-r from-blue-900 to-purple-900 rounded-lg p-6 mb-6 border border-blue-700">
        <h3 class="text-2xl font-bold mb-4">üéØ Priority Recommendations</h3>
        <div id="recommendationsContainer"></div>
      </div>
    </div>
  </div>

  <!-- Footer with Trust Signals -->
  <div class="max-w-5xl mx-auto mt-12 pb-8">
    <div class="bg-gray-800 rounded-lg p-6 text-center">
      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div>
          <div class="text-3xl mb-2">üèÜ</div>
          <div class="font-semibold text-white mb-1">78% Avg Recovery Rate</div>
          <div class="text-xs text-gray-400">200+ clients across 47+ countries</div>
        </div>
        <div>
          <div class="text-3xl mb-2">‚ö°</div>
          <div class="font-semibold text-white mb-1">90 Day Results</div>
          <div class="text-xs text-gray-400">Average traffic recovery within 3 months</div>
        </div>
        <div>
          <div class="text-3xl mb-2">üîí</div>
          <div class="font-semibold text-white mb-1">Privacy First</div>
          <div class="text-xs text-gray-400">Zero data collection, your content stays private</div>
        </div>
      </div>
      
      <div class="border-t border-gray-700 pt-4">
        <p class="text-sm text-gray-400 mb-2">
          Developed by <strong class="text-white">ContentScale</strong> - Expert SEO Recovery Service
        </p>
        <p class="text-xs text-gray-500 mb-3">
          Specializing in Google Algorithm Update Recovery & AI Overview Optimization
        </p>
        <div class="flex justify-center gap-4 text-xs">
          <a href="https://contentscale.site" target="_blank" class="text-purple-400 hover:text-purple-300">
            üåê contentscale.site
          </a>
          <a href="https://wa.me/31628073996" target="_blank" class="text-green-400 hover:text-green-300">
            üí¨ WhatsApp: +31 628073996
          </a>
        </div>
      </div>
    </div>
    
    <!-- Tech Stack Info -->
    <div class="mt-4 text-center text-xs text-gray-600">
      <p>
        Powered by: Puppeteer (JS Rendering) ‚Ä¢ Claude Sonnet 4 (AI Validation) ‚Ä¢ GRAAF+CRAFT Frameworks
      </p>
      <p class="mt-1">
        Version 1.0 Hybrid | Last Updated: December 2025
      </p>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURATION - SINGLE UNIFIED ENDPOINT
    // ============================================================================
    
    const CONFIG = {
      // CRITICAL: SINGLE SOURCE OF TRUTH
      // All features use this same endpoint
      scanEndpoint: '/api/scan',  // Unified endpoint
      claudeEnabled: true
    };

    // Toggle Claude features with clear feedback
    document.getElementById('claudeToggle').addEventListener('change', (e) => {
      CONFIG.claudeEnabled = e.target.checked;
      
      // Update mode display
      const currentMode = document.getElementById('currentMode');
      const modeDescription = document.getElementById('modeDescription');
      
      if (e.target.checked) {
        currentMode.innerHTML = 'ü§ñ AI Mode';
        currentMode.className = 'text-purple-400';
        modeDescription.textContent = 'Best experience: edge cases + educational tips';
      } else {
        currentMode.innerHTML = '‚ö° Basic Mode';
        currentMode.className = 'text-green-400';
        modeDescription.textContent = 'Quick analysis: formulas and scores only';
      }
      
      // Re-render if we have data
      if (window.lastScanData) {
        displayResults(window.lastScanData);
      }
    });

    // ============================================================================
    // LAYER 1-2: DETERMINISTIC CORE (Always runs - Pure JavaScript)
    // ============================================================================
    
    /**
     * Calculate DETERMINISTIC potential score
     * NO AI, NO GUESSING - Pure mathematical formulas
     * Same input = Same output ALWAYS
     */
    function calculateDeterministicPotential(data) {
      const current = Math.round(data.score || 0);
      const breakdown = data.breakdown || {};
      
      let quickWins = 0;
      const gains = {};
      
      // TECHNICAL SEO (12 points max realistic)
      const schemaScore = Math.round(breakdown.technical?.schemaMarkup || 0);
      gains.schema = 4 - schemaScore;
      quickWins += gains.schema;
      
      const metaScore = Math.round(breakdown.technical?.metaOptimization || 0);
      gains.meta = 4 - metaScore;
      quickWins += gains.meta;
      
      const mobileScore = Math.round(breakdown.technical?.mobileOptimization || 0);
      gains.mobile = 4 - mobileScore;
      quickWins += gains.mobile;
      
      // CRAFT FRAMEWORK (8 points max realistic)
      const faqScore = Math.round(breakdown.craft?.faqIntegration || 0);
      gains.faq = 4 - faqScore;
      quickWins += gains.faq;
      
      const visualsScore = Math.round(breakdown.craft?.addVisuals || 0);
      const visualsMissing = 6 - visualsScore;
      gains.visuals = Math.min(2, visualsMissing); // Can realistically add 2 images
      quickWins += gains.visuals;
      
      const reviewScore = Math.round(breakdown.craft?.reviewOptimize || 0);
      const reviewMissing = 8 - reviewScore;
      gains.review = Math.min(2, Math.ceil(reviewMissing * 0.25)); // Can fix TOC mainly
      quickWins += gains.review;
      
      return {
        current: current,
        potential: Math.min(100, current + quickWins),
        quickWins: quickWins,
        gains: gains
      };
    }

    // ============================================================================
    // LAYER 3: CLAUDE VALIDATION (Optional - Edge case detection)
    // ============================================================================
    
    /**
     * Validate deterministic calculation with Claude
     * Spots edge cases and quality issues
     */
    async function validateWithClaude(deterministicResult, fullData) {
      if (!CONFIG.claudeEnabled) {
        return {
          validated: deterministicResult.potential,
          adjustments: [],
          edgeCases: [],
          usedClaude: false
        };
      }

      const prompt = `You are an AI-era SEO expert validator. Analyze this content audit and validate the potential score calculation.

DETERMINISTIC CALCULATION:
- Current Score: ${deterministicResult.current}/100
- Calculated Potential: ${deterministicResult.potential}/100
- Quick Wins: +${deterministicResult.quickWins} points
- Breakdown: ${JSON.stringify(deterministicResult.gains)}

AUDIT DATA:
${JSON.stringify({
  faqCount: fullData.audit?.faqCount,
  faqAvgWords: fullData.audit?.faqAvgWords,
  expertQuotes: fullData.audit?.expertQuotes,
  statistics: fullData.audit?.statistics,
  sources: fullData.audit?.sources,
  images: fullData.audit?.images,
  altTexts: fullData.audit?.altTexts,
  schemaTypes: fullData.audit?.schemaTypes,
  wordCount: fullData.audit?.wordCount,
  metaTitleLength: fullData.audit?.metaTitleLength,
  metaDescLength: fullData.audit?.metaDescLength
}, null, 2)}

TASK: Check for edge cases that might make the potential score unrealistic:

1. FAQ Quality: Are answers long enough (100+ words) for schema to be valuable?
2. Image Quality: Do images have keyword-optimized alt texts?
3. Expert Quotes: Are quotes properly attributed (name, title, org)?
4. Statistics: Are they recent (2023-2025)?
5. Schema Readiness: Is content quality good enough for schema to work?

RETURN ONLY THIS JSON (no markdown, no explanation):
{
  "validatedPotential": <number>,
  "adjustments": [
    {"category": "string", "from": <number>, "to": <number>, "reason": "string"}
  ],
  "edgeCases": ["string"]
}`;

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1500,
            messages: [{
              role: "user",
              content: prompt
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`Claude API error: ${response.status}`);
        }

        const data = await response.json();
        const text = data.content[0].text;
        
        // Parse JSON (remove markdown if present)
        const cleanText = text.replace(/```json\n?|\n?```/g, '').trim();
        const result = JSON.parse(cleanText);
        
        return {
          ...result,
          usedClaude: true
        };
        
      } catch (error) {
        console.error('Claude validation failed:', error);
        // Fallback to deterministic
        return {
          validated: deterministicResult.potential,
          adjustments: [],
          edgeCases: [],
          usedClaude: false,
          error: error.message
        };
      }
    }

    // ============================================================================
    // LAYER 4: CLAUDE RECOMMENDATIONS (Optional - Educational)
    // ============================================================================
    
    /**
     * Generate detailed recommendations with WHY, HOW, WHAT, PRIORITY
     */
    async function generateRecommendationsWithClaude(data, validation) {
      if (!CONFIG.claudeEnabled) {
        return generateDeterministicRecommendations(data);
      }

      const prompt = `You are an AI-era SEO expert. Generate actionable recommendations for this content.

SCORES:
- Current: ${data.score}/100
- Validated Potential: ${validation.validated}/100

MISSING ELEMENTS:
${JSON.stringify(data.breakdown, null, 2)}

AUDIT DATA:
${JSON.stringify(data.audit, null, 2)}

Generate 5-8 recommendations prioritized by impact. For each:
1. WHY it matters (AI Overviews, E-E-A-T, user experience)
2. HOW to implement (specific steps)
3. WHAT impact (+X points, real-world benefit)
4. PRIORITY (critical/high/medium)
5. EFFORT (low=15min, medium=1-2hrs, high=4+hrs)

Focus on:
- Schema markup (critical for AI Overviews)
- FAQ optimization (detailed answers)
- Expert quotes (proper attribution)
- Statistics (recent, cited)
- Alt texts (keyword optimization)

RETURN ONLY THIS JSON:
{
  "recommendations": [
    {
      "text": "string",
      "why": "string (2-3 sentences)",
      "how": "string (specific steps)",
      "impact": <number>,
      "realWorldBenefit": "string",
      "priority": "critical|high|medium",
      "effort": "low|medium|high",
      "category": "technical|craft|graaf"
    }
  ]
}`;

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 3000,
            messages: [{
              role: "user",
              content: prompt
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`Claude API error: ${response.status}`);
        }

        const apiData = await response.json();
        const text = apiData.content[0].text;
        const cleanText = text.replace(/```json\n?|\n?```/g, '').trim();
        const result = JSON.parse(cleanText);
        
        return result.recommendations;
        
      } catch (error) {
        console.error('Claude recommendations failed:', error);
        return generateDeterministicRecommendations(data);
      }
    }

    /**
     * Fallback: Generate deterministic recommendations
     */
    function generateDeterministicRecommendations(data) {
      const recs = [];
      const breakdown = data.breakdown;
      const audit = data.audit;
      
      // Schema markup
      if (breakdown.technical?.schemaMarkup < 4) {
        recs.push({
          text: "Add Article + FAQPage schema markup (JSON-LD)",
          why: "67% of searches now show AI Overviews. Without schema markup, your content is invisible to AI. Article schema provides the foundation, while FAQPage schema enables expandable answers in search results.",
          how: "1. Copy Article schema template\n2. Fill in your content details\n3. Add FAQPage schema for all FAQ questions\n4. Paste into <head> section\n5. Validate with schema.org validator",
          impact: 4 - breakdown.technical.schemaMarkup,
          realWorldBenefit: "Appear in AI Overviews, Featured Snippets, and Rich Results",
          priority: "critical",
          effort: "low",
          category: "technical"
        });
      }
      
      // FAQ quality
      if (breakdown.craft?.faqIntegration < 4 && audit.faqCount > 0) {
        recs.push({
          text: `Expand FAQ answers to 100+ words (currently ${audit.faqAvgWords} words avg)`,
          why: "AI Overviews prefer detailed, comprehensive answers. Short answers (< 100 words) are rarely cited. Longer answers with examples, statistics, and sources rank better.",
          how: "1. Review each FAQ answer\n2. Add specific examples\n3. Include relevant statistics\n4. Link to authoritative sources\n5. Aim for 100-150 words per answer",
          impact: 4 - breakdown.craft.faqIntegration,
          realWorldBenefit: "Higher chance of AI Overview citation and Featured Snippets",
          priority: "high",
          effort: "medium",
          category: "craft"
        });
      }
      
      // Meta optimization
      if (breakdown.technical?.metaOptimization < 4) {
        recs.push({
          text: "Optimize meta title and description",
          why: "Meta tags are the first thing users see in search results. Well-optimized meta tags improve click-through rates by 20-30%.",
          how: `1. Title: Keep 50-60 chars, keyword within first 30\n2. Current: ${audit.metaTitleLength} chars\n3. Description: 150-160 chars with keyword and CTA\n4. Current: ${audit.metaDescLength} chars`,
          impact: 4 - breakdown.technical.metaOptimization,
          realWorldBenefit: "+20-30% click-through rate from search results",
          priority: "high",
          effort: "low",
          category: "technical"
        });
      }
      
      // Mobile optimization
      if (breakdown.technical?.mobileOptimization < 4) {
        const missingAltTexts = audit.images - audit.altTexts;
        recs.push({
          text: `Add alt texts to ${missingAltTexts} images with keyword optimization`,
          why: "60% of searches happen on mobile. Missing alt texts hurt accessibility, mobile SEO, and image search rankings.",
          how: "1. Review each image\n2. Write descriptive alt text (10-15 words)\n3. Include target keyword naturally\n4. Describe what's actually in the image",
          impact: 4 - breakdown.technical.mobileOptimization,
          realWorldBenefit: "Better mobile rankings + image search visibility",
          priority: "medium",
          effort: "low",
          category: "technical"
        });
      }
      
      return recs;
    }

    // ============================================================================
    // MAIN SCAN FUNCTION
    // ============================================================================
    
    async function scanURL() {
      const url = document.getElementById('urlInput').value.trim();
      
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('Please enter a valid URL (must start with http:// or https://)');
        return;
      }
      
      // Show loading
      document.getElementById('loadingIndicator').classList.remove('hidden');
      document.getElementById('resultsContainer').classList.add('hidden');
      document.getElementById('loadingText').textContent = 'Scanning content...';
      
      try {
        // Step 1: Get deterministic score from backend (UNIFIED ENDPOINT)
        document.getElementById('loadingText').textContent = 'Analyzing content (Layer 1: Backend)...';
        
        // CRITICAL: SINGLE UNIFIED ENDPOINT
        const response = await fetch(`${CONFIG.scanEndpoint}?url=${encodeURIComponent(url)}`);
        
        if (!response.ok) {
          throw new Error(`Scan failed: ${response.statusText}`);
        }
        
        const data = await response.json();
        window.lastScanData = data; // Store for toggle
        
        // Step 2: Calculate deterministic potential
        document.getElementById('loadingText').textContent = 'Calculating potential (Layer 2: Formulas)...';
        const deterministicResult = calculateDeterministicPotential(data);
        
        // Step 3: Validate with Claude (if enabled)
        let validation;
        if (CONFIG.claudeEnabled) {
          document.getElementById('loadingText').textContent = 'Validating with AI (Layer 3: Claude)...';
          validation = await validateWithClaude(deterministicResult, data);
        } else {
          validation = {
            validated: deterministicResult.potential,
            adjustments: [],
            edgeCases: [],
            usedClaude: false
          };
        }
        
        // Step 4: Generate recommendations
        let recommendations;
        if (CONFIG.claudeEnabled) {
          document.getElementById('loadingText').textContent = 'Generating recommendations (Layer 4: Claude)...';
          recommendations = await generateRecommendationsWithClaude(data, validation);
        } else {
          recommendations = generateDeterministicRecommendations(data);
        }
        
        // Display results
        displayResults({
          ...data,
          deterministicResult,
          validation,
          recommendations
        });
        
      } catch (error) {
        console.error('Scan error:', error);
        alert(`Scan failed: ${error.message}`);
      } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
      }
    }

    // ============================================================================
    // DISPLAY RESULTS
    // ============================================================================
    
    function displayResults(data) {
      const { deterministicResult, validation, recommendations } = data;
      
      // Show results container
      document.getElementById('resultsContainer').classList.remove('hidden');
      
      // Current Score
      document.getElementById('currentScore').textContent = Math.round(data.score);
      
      // Deterministic Potential
      document.getElementById('deterministicPotential').textContent = deterministicResult.potential;
      
      // AI-Validated Potential
      const validatedScore = validation.validated || deterministicResult.potential;
      document.getElementById('validatedPotential').textContent = validatedScore;
      
      // Validation Status
      const validationStatus = document.getElementById('validationStatus');
      if (CONFIG.claudeEnabled && validation.usedClaude) {
        const diff = validatedScore - deterministicResult.potential;
        if (diff !== 0) {
          validationStatus.innerHTML = `
            <div class="mt-3 p-3 bg-purple-900 bg-opacity-50 rounded-lg border border-purple-500">
              <div class="flex items-center gap-2">
                <span class="text-purple-400">ü§ñ AI Adjustment:</span>
                <span class="text-white font-semibold">${diff > 0 ? '+' : ''}${diff} points</span>
                <span class="text-gray-400 text-sm">(${deterministicResult.potential} ‚Üí ${validatedScore})</span>
              </div>
            </div>
          `;
          validationStatus.classList.remove('hidden');
        } else {
          validationStatus.innerHTML = `
            <div class="mt-3 p-3 bg-green-900 bg-opacity-30 rounded-lg border border-green-500">
              <div class="text-green-400 text-sm">‚úÖ AI validation confirms deterministic calculation</div>
            </div>
          `;
          validationStatus.classList.remove('hidden');
        }
      } else {
        validationStatus.classList.add('hidden');
      }
      
      // Target Message
      const targetMsg = document.getElementById('targetMessage');
      if (validatedScore >= 95) {
        targetMsg.innerHTML = `<div class="text-green-400 font-semibold">‚úÖ Excellent! Target of 95+ is achievable with these fixes!</div>`;
      } else if (validatedScore >= 90) {
        targetMsg.innerHTML = `<div class="text-yellow-400 font-semibold">‚ö†Ô∏è Close! To reach 95+, focus on content quality improvements.</div>`;
      } else {
        targetMsg.innerHTML = `<div class="text-blue-400">üìä Focus on quick wins first (+${validatedScore - Math.round(data.score)} points), then reassess for deeper optimization.</div>`;
      }
      
      // Score Breakdown
      displayScoreBreakdown(data);
      
      // AI Insights
      if (CONFIG.claudeEnabled && validation.usedClaude) {
        displayAIInsights(validation);
      } else {
        document.getElementById('aiInsights').classList.add('hidden');
      }
      
      // Recommendations
      displayRecommendations(recommendations, CONFIG.claudeEnabled);
    }

    function displayScoreBreakdown(data) {
      const breakdown = data.breakdown;
      const html = `
        <!-- GRAAF Framework -->
        <div class="mb-3">
          <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600" onclick="toggleCalc('graaf-breakdown')">
            <div class="flex items-center gap-3">
              <span class="text-lg">üéØ GRAAF Framework:</span>
              <span class="font-bold text-xl">${breakdown.graaf.total}/50</span>
            </div>
            <span class="text-gray-400 text-sm">Click to expand ‚ñº</span>
          </div>
          <div id="graaf-breakdown" class="calc-breakdown">
            <div class="space-y-2">
              <div>‚Ä¢ Credibility: ${breakdown.graaf.credibility}/10 (expert quotes, statistics, sources)</div>
              <div>‚Ä¢ Relevance: ${breakdown.graaf.relevance}/10 (keyword optimization)</div>
              <div>‚Ä¢ Actionability: ${breakdown.graaf.actionability}/10 (step-by-step, examples)</div>
              <div>‚Ä¢ Accuracy: ${breakdown.graaf.accuracy}/10 (data citations, case studies)</div>
              <div>‚Ä¢ Freshness: ${breakdown.graaf.freshness}/10 (recent updates, current data)</div>
            </div>
          </div>
        </div>

        <!-- CRAFT Framework -->
        <div class="mb-3">
          <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600" onclick="toggleCalc('craft-breakdown')">
            <div class="flex items-center gap-3">
              <span class="text-lg">‚ú® CRAFT Framework:</span>
              <span class="font-bold text-xl">${breakdown.craft.total}/30</span>
            </div>
            <span class="text-gray-400 text-sm">Click to expand ‚ñº</span>
          </div>
          <div id="craft-breakdown" class="calc-breakdown">
            <div class="space-y-2">
              <div>‚Ä¢ Cut Fluff: ${breakdown.craft.cutFluff}/8 (readability, sentence length)</div>
              <div>‚Ä¢ Review & Optimize: ${breakdown.craft.reviewOptimize}/8 (meta tags, headings)</div>
              <div>‚Ä¢ Add Visuals: ${breakdown.craft.addVisuals}/6 (images, tables, videos)</div>
              <div>‚Ä¢ FAQ Integration: ${breakdown.craft.faqIntegration}/4 (count, quality, schema)</div>
              <div>‚Ä¢ Trust Building: ${breakdown.craft.trustBuilding}/4 (author bio, credentials)</div>
            </div>
          </div>
        </div>

        <!-- Technical SEO -->
        <div class="mb-3">
          <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600" onclick="toggleCalc('technical-breakdown')">
            <div class="flex items-center gap-3">
              <span class="text-lg">‚öôÔ∏è Technical SEO:</span>
              <span class="font-bold text-xl">${breakdown.technical.total}/20</span>
            </div>
            <span class="text-gray-400 text-sm">Click to expand ‚ñº</span>
          </div>
          <div id="technical-breakdown" class="calc-breakdown">
            <div class="space-y-2">
              <div>‚Ä¢ Meta Optimization: ${breakdown.technical.metaOptimization}/4 (title, description)</div>
              <div>‚Ä¢ Schema Markup: ${breakdown.technical.schemaMarkup}/4 (Article, FAQ, HowTo)</div>
              <div>‚Ä¢ Internal Linking: ${breakdown.technical.internalLinking}/4 (contextual links)</div>
              <div>‚Ä¢ Page Structure: ${breakdown.technical.pageStructure}/4 (headings, word count)</div>
              <div>‚Ä¢ Mobile Optimization: ${breakdown.technical.mobileOptimization}/4 (responsive, alt texts)</div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('scoreBreakdown').innerHTML = html;
    }

    function displayAIInsights(validation) {
      const aiInsights = document.getElementById('aiInsights');
      
      if (validation.adjustments && validation.adjustments.length > 0) {
        const adjustmentsList = validation.adjustments.map(adj => `
          <div class="adjustment-card">
            <div class="font-semibold text-gray-900">${adj.category}: ${adj.from} ‚Üí ${adj.to} points</div>
            <div class="text-sm text-gray-700 mt-1">${adj.reason}</div>
          </div>
        `).join('');
        
        document.getElementById('adjustmentsList').innerHTML = adjustmentsList;
        document.getElementById('adjustmentsContainer').classList.remove('hidden');
      } else {
        document.getElementById('adjustmentsContainer').classList.add('hidden');
      }
      
      if (validation.edgeCases && validation.edgeCases.length > 0) {
        const edgeCasesList = validation.edgeCases.map(edge => `
          <div class="edge-case-card">
            <div class="text-sm text-blue-900">${edge}</div>
          </div>
        `).join('');
        
        document.getElementById('edgeCasesList').innerHTML = edgeCasesList;
        document.getElementById('edgeCasesContainer').classList.remove('hidden');
      } else {
        document.getElementById('edgeCasesContainer').classList.add('hidden');
      }
      
      aiInsights.classList.remove('hidden');
    }

    function displayRecommendations(recommendations, usedClaude) {
      const priorityOrder = { critical: 1, high: 2, medium: 3 };
      const sortedRecs = recommendations.sort((a, b) => 
        priorityOrder[a.priority] - priorityOrder[b.priority]
      );
      
      const html = sortedRecs.map((rec, idx) => {
        const priorityColors = {
          critical: 'bg-red-900 border-red-500 text-red-200',
          high: 'bg-orange-900 border-orange-500 text-orange-200',
          medium: 'bg-blue-900 border-blue-500 text-blue-200'
        };
        
        const effortBadges = {
          low: '<span class="px-2 py-1 bg-green-600 text-white rounded text-xs">‚ö° 15 min</span>',
          medium: '<span class="px-2 py-1 bg-yellow-600 text-white rounded text-xs">‚è±Ô∏è 1-2 hrs</span>',
          high: '<span class="px-2 py-1 bg-red-600 text-white rounded text-xs">üî• 4+ hrs</span>'
        };
        
        return `
          <div class="recommendation bg-gray-800 rounded-lg p-5 mb-4 border-l-4 ${priorityColors[rec.priority]}">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-bold text-lg flex-1">${idx + 1}. ${rec.text}</h4>
              <div class="flex items-center gap-2">
                ${effortBadges[rec.effort]}
                <span class="px-3 py-1 bg-purple-600 text-white rounded-full text-sm font-semibold">+${rec.impact} pts</span>
              </div>
            </div>
            
            ${usedClaude ? `
              <div class="space-y-3 text-sm">
                <div>
                  <div class="text-gray-400 font-semibold mb-1">üí° Why This Matters:</div>
                  <div class="text-gray-300">${rec.why}</div>
                </div>
                
                <div>
                  <div class="text-gray-400 font-semibold mb-1">üîß How to Implement:</div>
                  <div class="text-gray-300 whitespace-pre-line">${rec.how}</div>
                </div>
                
                <div>
                  <div class="text-gray-400 font-semibold mb-1">üìà Real-World Benefit:</div>
                  <div class="text-gray-300">${rec.realWorldBenefit}</div>
                </div>
              </div>
            ` : `
              <div class="text-sm text-gray-400">
                Enable AI mode for detailed WHY, HOW, and real-world benefits
              </div>
            `}
          </div>
        `;
      }).join('');
      
      document.getElementById('recommendationsContainer').innerHTML = html;
    }

    function toggleCalc(id) {
      const el = document.getElementById(id);
      el.classList.toggle('open');
    }
  </script>
</body>
</html>
