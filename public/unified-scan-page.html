<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ContentScale - AI-Powered SEO Content Analyzer</title>
  <meta name="description" content="Advanced SEO content analysis with hybrid AI. Get deterministic scoring + Claude AI validation for the most accurate SEO recommendations.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .calc-breakdown { display: none; padding: 12px; background: #1f2937; border-radius: 8px; margin-top: 8px; }
    .calc-breakdown.open { display: block; }
    .score-formula { font-family: 'Courier New', monospace; background: #111827; padding: 8px; border-radius: 4px; font-size: 13px; }
    .recommendation { cursor: pointer; transition: all 0.2s; }
    .recommendation:hover { transform: translateX(4px); }
    .hybrid-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .hybrid-badge.deterministic { background: #10b981; color: white; }
    .hybrid-badge.ai-validated { background: #8b5cf6; color: white; }
    .adjustment-card { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px; margin: 8px 0; }
    .edge-case-card { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 4px; margin: 8px 0; }
    .toggle-switch { position: relative; width: 48px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #6b7280; transition: .4s; border-radius: 24px; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #8b5cf6; }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
    .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #8b5cf6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tooltip { position: relative; display: inline-block; cursor: help; }
    .tooltip .tooltiptext { visibility: hidden; width: 280px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 6px; padding: 12px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -140px; opacity: 0; transition: opacity 0.3s; font-size: 12px; border: 1px solid #4b5563; }
    .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .info-icon { display: inline-block; width: 16px; height: 16px; background: #6b7280; color: white; border-radius: 50%; text-align: center; line-height: 16px; font-size: 11px; font-weight: bold; margin-left: 4px; }
    details summary { list-style: none; }
    details summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8">
  <div class="max-w-5xl mx-auto">
    <!-- Hero Title (Compact) -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold mb-3 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
        ContentScale AI SEO Analyzer
      </h1>
      <p class="text-xl text-gray-300">The Most Advanced SEO Scoring System</p>
    </div>

    <!-- SCAN FORM (TOP - Most Visible!) -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-8 mb-6 shadow-2xl border-2 border-purple-500">
      <h2 class="text-3xl font-bold mb-2 text-center">üîç Scan Your Content</h2>
      <p class="text-sm text-gray-400 text-center mb-6">Get your SEO score in ~10 seconds</p>
      
      <div class="flex gap-3 mb-5">
        <input 
          type="text" 
          id="urlInput" 
          placeholder="https://example.com/your-article"
          class="flex-1 bg-gray-700 text-white px-6 py-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg shadow-inner"
        >
        <button 
          onclick="scanURL()"
          class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 px-12 py-4 rounded-lg font-bold text-lg transition shadow-lg hover:shadow-xl"
        >
          Scan Now
        </button>
      </div>
      
      <!-- Compact Mode Selector (Inline) -->
      <div class="bg-gray-800 bg-opacity-70 rounded-lg p-4 mb-4 border border-gray-700">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-bold" id="currentMode">ü§ñ AI Mode</span>
              <span class="text-xs bg-purple-600 px-2 py-0.5 rounded-full font-semibold">RECOMMENDED</span>
            </div>
            <div class="text-xs text-gray-400" id="modeDescription">
              Edge case detection ‚Ä¢ Educational WHY/HOW ‚Ä¢ AI-era SEO insights
            </div>
          </div>
          <label class="toggle-switch ml-4 flex-shrink-0">
            <input type="checkbox" id="claudeToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <!-- Expandable Comparison -->
        <details class="mt-3">
          <summary class="text-xs text-purple-400 cursor-pointer hover:text-purple-300 select-none">
            ‚ñ∏ What's the difference between modes? (click to expand)
          </summary>
          <div class="mt-3 grid md:grid-cols-2 gap-3 text-xs">
            <!-- Basic Mode -->
            <div class="bg-gray-900 bg-opacity-70 rounded-lg p-3 border border-gray-700">
              <div class="font-bold text-green-400 mb-2 flex items-center justify-between">
                <span>‚ö° Basic Mode</span>
                <span class="text-green-300 text-xs">FREE</span>
              </div>
              <div class="space-y-1.5 text-gray-400">
                <div>‚úì Score calculation (0-100)</div>
                <div>‚úì Potential score (formulas)</div>
                <div>‚úì Basic recommendations</div>
                <div class="text-gray-600">‚úó Edge case detection</div>
                <div class="text-gray-600">‚úó Educational WHY/HOW</div>
                <div class="text-gray-600">‚úó AI-era SEO insights</div>
              </div>
              <div class="mt-3 pt-3 border-t border-gray-800 text-gray-500">
                ‚ö° ~3 seconds | Quick check
              </div>
            </div>
            
            <!-- AI Mode -->
            <div class="bg-purple-900 bg-opacity-40 rounded-lg p-3 border-2 border-purple-500">
              <div class="font-bold text-purple-400 mb-2 flex items-center justify-between">
                <span>ü§ñ AI Mode</span>
                <span class="text-purple-300 text-xs">BEST</span>
              </div>
              <div class="space-y-1.5 text-gray-300">
                <div>‚úì <strong>Everything from Basic</strong></div>
                <div>‚úì AI validation (edge cases)</div>
                <div>‚úì Educational explanations</div>
                <div>‚úì WHY, HOW, WHAT for each fix</div>
                <div>‚úì AI-era SEO insights</div>
                <div>‚úì Priority ranking</div>
              </div>
              <div class="mt-3 pt-3 border-t border-purple-800 text-gray-400">
                ‚ö° ~10 seconds | Deep analysis + learning
              </div>
            </div>
          </div>
        </details>
      </div>
      
      <!-- Example & Speed Info -->
      <div class="flex items-center justify-between text-xs">
        <div class="text-gray-400">
          <span class="text-gray-500">üí° Try example:</span>
          <button 
            onclick="document.getElementById('urlInput').value='https://contentscale.site'; scanURL();"
            class="text-purple-400 hover:text-purple-300 underline ml-1 font-semibold"
          >
            ContentScale.site
          </button>
        </div>
        <div class="text-gray-500">
          ‚ö° Analysis speed: ~10s (AI) | ~3s (Basic)
        </div>
      </div>
      
      <!-- Loading Indicator -->
      <div id="loadingIndicator" class="hidden mt-6 text-center">
        <div class="inline-flex items-center gap-3 bg-gray-800 px-6 py-4 rounded-lg">
          <div class="loading-spinner"></div>
          <span class="text-gray-300 font-semibold" id="loadingText">Scanning content...</span>
        </div>
      </div>
    </div>

    <!-- Value Propositions -->
    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-800 rounded-lg p-5 text-center border border-gray-700 hover:border-purple-500 transition">
        <div class="text-4xl mb-3">üéØ</div>
        <div class="font-bold text-white mb-2">100% Reliable</div>
        <div class="text-sm text-gray-400">Deterministic core - always same result for same content</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-5 text-center border border-gray-700 hover:border-purple-500 transition">
        <div class="text-4xl mb-3">ü§ñ</div>
        <div class="font-bold text-white mb-2">AI-Powered Insights</div>
        <div class="text-sm text-gray-400">Claude AI spots edge cases and provides educational recommendations</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-5 text-center border border-gray-700 hover:border-purple-500 transition">
        <div class="text-4xl mb-3">üìö</div>
        <div class="font-bold text-white mb-2">Learn & Improve</div>
        <div class="text-sm text-gray-400">Understand WHY it matters and HOW to implement fixes</div>
      </div>
    </div>

    <!-- How It Works -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8 border border-gray-700">
      <h3 class="font-bold text-white mb-5 text-center text-lg">‚ö° How It Works (4 Layers)</h3>
      <div class="grid md:grid-cols-4 gap-4">
        <div class="text-center">
          <div class="bg-green-600 text-white rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-lg shadow-lg">1</div>
          <div class="font-semibold text-green-400 mb-1 text-sm">Backend Scan</div>
          <div class="text-xs text-gray-400">Puppeteer analyzes 100+ metrics</div>
        </div>
        <div class="text-center">
          <div class="bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-lg shadow-lg">2</div>
          <div class="font-semibold text-blue-400 mb-1 text-sm">Score Formulas</div>
          <div class="text-xs text-gray-400">GRAAF + CRAFT + Technical = 100pts</div>
        </div>
        <div class="text-center">
          <div class="bg-purple-600 text-white rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-lg shadow-lg">3</div>
          <div class="font-semibold text-purple-400 mb-1 text-sm">AI Validation</div>
          <div class="text-xs text-gray-400">Claude spots quality issues</div>
        </div>
        <div class="text-center">
          <div class="bg-pink-600 text-white rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-lg shadow-lg">4</div>
          <div class="font-semibold text-pink-400 mb-1 text-sm">Smart Advice</div>
          <div class="text-xs text-gray-400">WHY, HOW, WHAT for each fix</div>
        </div>
      </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
      <!-- Score Overview -->
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg p-6 mb-6 shadow-lg border border-gray-700">
        <h2 class="text-2xl font-bold mb-4">üìä Your SEO Score</h2>
        
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <!-- Current Score -->
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-2 flex items-center justify-center gap-1">
              Current Score
              <div class="tooltip">
                <span class="info-icon">i</span>
                <span class="tooltiptext">
                  <strong>Current Score</strong><br>
                  Backend analyzes 100+ metrics:<br>
                  ‚Ä¢ GRAAF: 50pts (SEO fundamentals)<br>
                  ‚Ä¢ CRAFT: 30pts (Content quality)<br>
                  ‚Ä¢ Technical: 20pts (Schema, meta, mobile)<br>
                  <em>100% deterministic - always same result.</em>
                </span>
              </div>
            </div>
            <div class="text-4xl font-bold text-yellow-400" id="currentScore">--</div>
            <div class="text-xs text-gray-500 mt-1">
              <span class="hybrid-badge deterministic">Backend</span>
            </div>
          </div>
          
          <!-- Deterministic Potential -->
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-sm text-gray-400 mb-2 flex items-center justify-center gap-1">
              Calculated Potential
              <div class="tooltip">
                <span class="info-icon">i</span>
                <span class="tooltiptext">
                  <strong>Calculated Potential</strong><br>
                  Exact calculation with formulas:<br>
                  ‚Ä¢ Missing schema ‚Üí +4pts<br>
                  ‚Ä¢ Missing meta ‚Üí +1-2pts<br>
                  ‚Ä¢ Missing mobile/FAQ ‚Üí +2-4pts<br>
                  <em>Pure math - what you CAN achieve with quick fixes.</em>
                </span>
              </div>
            </div>
            <div class="text-4xl font-bold text-blue-400" id="deterministicPotential">--</div>
            <div class="text-xs text-gray-500 mt-1">
              <span class="hybrid-badge deterministic">Formulas</span>
            </div>
          </div>
          
          <!-- AI-Validated Potential -->
          <div class="bg-gray-800 rounded-lg p-4 text-center border-2 border-purple-500">
            <div class="text-sm text-gray-400 mb-2 flex items-center justify-center gap-1">
              AI-Validated Potential
              <div class="tooltip">
                <span class="info-icon">i</span>
                <span class="tooltiptext">
                  <strong>AI-Validated Potential</strong><br>
                  Claude AI validates the calculation:<br>
                  ‚Ä¢ FAQ answers too short?<br>
                  ‚Ä¢ Alt texts without keywords?<br>
                  ‚Ä¢ Expert quotes without attribution?<br>
                  <em>Can deviate -2 to +2 pts if Claude finds quality issues.</em>
                </span>
              </div>
            </div>
            <div class="text-4xl font-bold text-purple-400" id="validatedPotential">--</div>
            <div class="text-xs text-gray-500 mt-1">
              <span class="hybrid-badge ai-validated">Claude AI</span>
            </div>
          </div>
        </div>

        <!-- Validation Status -->
        <div id="validationStatus" class="hidden"></div>
        
        <!-- Target Message -->
        <div id="targetMessage" class="text-center pt-3 border-t border-gray-700"></div>
      </div>

      <!-- Score Breakdown (Expandable) -->
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">üìà Score Breakdown (Click to Expand)</h3>
        <div id="scoreBreakdown"></div>
      </div>

      <!-- AI Validation Insights (if enabled) -->
      <div id="aiInsights" class="hidden bg-gradient-to-r from-purple-900 to-blue-900 rounded-lg p-6 mb-6 border border-purple-500">
        <h3 class="text-xl font-bold mb-4">ü§ñ AI Validation Insights</h3>
        
        <!-- Adjustments -->
        <div id="adjustmentsContainer" class="hidden mb-4">
          <h4 class="font-semibold mb-2">‚öñÔ∏è Score Adjustments:</h4>
          <div id="adjustmentsList"></div>
        </div>
        
        <!-- Edge Cases -->
        <div id="edgeCasesContainer" class="hidden mb-4">
          <h4 class="font-semibold mb-2">üîç Edge Cases Detected:</h4>
          <div id="edgeCasesList"></div>
        </div>
      </div>

      <!-- Priority Recommendations -->
      <div class="bg-gradient-to-r from-blue-900 to-purple-900 rounded-lg p-6 mb-6 border border-blue-700">
        <h3 class="text-2xl font-bold mb-4">üéØ Priority Recommendations</h3>
        <div id="recommendationsContainer"></div>
      </div>
    </div>
  </div>

  <!-- Footer with Trust Signals -->
  <div class="max-w-5xl mx-auto mt-12 pb-8">
    <div class="bg-gray-800 rounded-lg p-6 text-center">
      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div>
          <div class="text-3xl mb-2">üèÜ</div>
          <div class="font-semibold text-white mb-1">78% Avg Recovery Rate</div>
          <div class="text-xs text-gray-400">200+ clients across 47+ countries</div>
        </div>
        <div>
          <div class="text-3xl mb-2">‚ö°</div>
          <div class="font-semibold text-white mb-1">90 Day Results</div>
          <div class="text-xs text-gray-400">Average traffic recovery within 3 months</div>
        </div>
        <div>
          <div class="text-3xl mb-2">üîí</div>
          <div class="font-semibold text-white mb-1">Privacy First</div>
          <div class="text-xs text-gray-400">Zero data collection, your content stays private</div>
        </div>
      </div>
      
      <div class="border-t border-gray-700 pt-4">
        <p class="text-sm text-gray-400 mb-2">
          Developed by <strong class="text-white">ContentScale</strong> - Expert SEO Recovery Service
        </p>
        <p class="text-xs text-gray-500 mb-3">
          Specializing in Google Algorithm Update Recovery & AI Overview Optimization
        </p>
        <div class="flex justify-center gap-4 text-xs">
          <a href="https://contentscale.site" target="_blank" class="text-purple-400 hover:text-purple-300">
            üåê contentscale.site
          </a>
          <a href="https://wa.me/31628073996" target="_blank" class="text-green-400 hover:text-green-300">
            üí¨ WhatsApp: +31 628073996
          </a>
        </div>
      </div>
    </div>
    
    <!-- Tech Stack Info -->
    <div class="mt-4 text-center text-xs text-gray-600">
      <p>
        Powered by: Puppeteer (JS Rendering) ‚Ä¢ Claude Sonnet 4 (AI Validation) ‚Ä¢ GRAAF+CRAFT Frameworks
      </p>
      <p class="mt-1">
        Version 1.0 Hybrid | Last Updated: December 2025
      </p>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURATION - SINGLE UNIFIED ENDPOINT
    // ============================================================================
    
    const CONFIG = {
      scanEndpoint: '/api/scan',  // Fresh scan with full audit data
      claudeEnabled: true
    };

    // Toggle Claude features
    document.getElementById('claudeToggle').addEventListener('change', (e) => {
      CONFIG.claudeEnabled = e.target.checked;
      
      // Update mode display
      const currentMode = document.getElementById('currentMode');
      const modeDescription = document.getElementById('modeDescription');
      
      if (e.target.checked) {
        currentMode.innerHTML = 'ü§ñ AI Mode';
        currentMode.className = 'text-sm font-bold text-purple-400';
        modeDescription.textContent = 'Edge case detection ‚Ä¢ Educational WHY/HOW ‚Ä¢ AI-era SEO insights';
      } else {
        currentMode.innerHTML = '‚ö° Basic Mode';
        currentMode.className = 'text-sm font-bold text-green-400';
        modeDescription.textContent = 'Quick analysis ‚Ä¢ Formulas and scores only ‚Ä¢ ~3 seconds';
      }
      
      if (window.lastScanData) {
        displayResults(window.lastScanData);
      }
    });

    // ============================================================================
    // LAYER 1-2: DETERMINISTIC CORE
    // ============================================================================
    
    function calculateDeterministicPotential(data) {
      const current = Math.round(data.score || 0);
      const breakdown = data.breakdown || {};
      
      let quickWins = 0;
      const gains = {};
      
      // Check if we have detailed breakdown or just totals
      const hasDetailedBreakdown = breakdown.technical?.schemaMarkup !== undefined;
      
      if (hasDetailedBreakdown) {
        // DETAILED BREAKDOWN - Use sub-scores
        
        // TECHNICAL SEO (12 points max)
        const schemaScore = Math.round(breakdown.technical?.schemaMarkup || 0);
        gains.schema = Math.max(0, 4 - schemaScore);
        quickWins += gains.schema;
        
        const metaScore = Math.round(breakdown.technical?.metaOptimization || 0);
        gains.meta = Math.max(0, 4 - metaScore);
        quickWins += gains.meta;
        
        const mobileScore = Math.round(breakdown.technical?.mobileOptimization || 0);
        gains.mobile = Math.max(0, 4 - mobileScore);
        quickWins += gains.mobile;
        
        // CRAFT FRAMEWORK (8 points max)
        const faqScore = Math.round(breakdown.craft?.faqIntegration || 0);
        gains.faq = Math.max(0, 4 - faqScore);
        quickWins += gains.faq;
        
        const visualsScore = Math.round(breakdown.craft?.addVisuals || 0);
        const visualsMissing = 6 - visualsScore;
        gains.visuals = Math.min(2, Math.max(0, visualsMissing));
        quickWins += gains.visuals;
        
        const reviewScore = Math.round(breakdown.craft?.reviewOptimize || 0);
        const reviewMissing = 8 - reviewScore;
        gains.review = Math.min(2, Math.max(0, Math.ceil(reviewMissing * 0.25)));
        quickWins += gains.review;
        
      } else {
        // SIMPLIFIED BREAKDOWN - Estimate based on totals
        console.log('‚ö†Ô∏è Using simplified breakdown - estimating potential');
        
        // Technical SEO (max 20 points)
        const technicalTotal = breakdown.technical?.total || 0;
        const technicalMissing = Math.max(0, 20 - technicalTotal);
        
        // Estimate realistic gains (typically 60% of missing points are quick wins)
        const technicalGains = Math.min(12, Math.ceil(technicalMissing * 0.6));
        gains.technical = technicalGains;
        quickWins += technicalGains;
        
        // CRAFT (max 30 points)
        const craftTotal = breakdown.craft?.total || 0;
        const craftMissing = Math.max(0, 30 - craftTotal);
        
        // Estimate realistic gains (typically 25% of missing points are quick wins)
        const craftGains = Math.min(8, Math.ceil(craftMissing * 0.25));
        gains.craft = craftGains;
        quickWins += craftGains;
        
        // GRAAF is harder to improve quickly, skip for quick wins
        gains.graaf = 0;
      }
      
      return {
        current: current,
        potential: Math.min(100, current + quickWins),
        quickWins: quickWins,
        gains: gains
      };
    }

    // ============================================================================
    // LAYER 3: CLAUDE VALIDATION
    // ============================================================================
    
    async function validateWithClaude(deterministicResult, fullData) {
      if (!CONFIG.claudeEnabled) {
        return {
          validated: deterministicResult.potential,
          adjustments: [],
          edgeCases: [],
          usedClaude: false
        };
      }

      const prompt = `You are an AI-era SEO expert validator. Analyze this content audit and validate the potential score calculation.

DETERMINISTIC CALCULATION:
- Current Score: ${deterministicResult.current}/100
- Calculated Potential: ${deterministicResult.potential}/100
- Quick Wins: +${deterministicResult.quickWins} points

AUDIT DATA:
${JSON.stringify({
  faqCount: fullData.audit?.faqCount,
  faqAvgWords: fullData.audit?.faqAvgWords,
  expertQuotes: fullData.audit?.expertQuotes,
  statistics: fullData.audit?.statistics,
  images: fullData.audit?.images,
  altTexts: fullData.audit?.altTexts,
  schemaTypes: fullData.audit?.schemaTypes
}, null, 2)}

Check for edge cases. Return ONLY JSON:
{
  "validatedPotential": <number>,
  "adjustments": [{"category": "string", "from": <number>, "to": <number>, "reason": "string"}],
  "edgeCases": ["string"]
}`;

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1500,
            messages: [{ role: "user", content: prompt }]
          })
        });

        if (!response.ok) throw new Error(`Claude API error: ${response.status}`);

        const data = await response.json();
        const text = data.content[0].text;
        const cleanText = text.replace(/```json\n?|\n?```/g, '').trim();
        const result = JSON.parse(cleanText);
        
        return { ...result, usedClaude: true };
        
      } catch (error) {
        console.error('Claude validation failed:', error);
        return {
          validated: deterministicResult.potential,
          adjustments: [],
          edgeCases: [],
          usedClaude: false
        };
      }
    }

    // ============================================================================
    // LAYER 4: RECOMMENDATIONS
    // ============================================================================
    
    async function generateRecommendationsWithClaude(data, validation) {
      if (!CONFIG.claudeEnabled) {
        return generateDeterministicRecommendations(data);
      }

      const prompt = `Generate actionable SEO recommendations.

SCORES:
- Current: ${data.score}/100
- Validated Potential: ${validation.validated}/100

Generate 5-8 recommendations with WHY, HOW, WHAT, PRIORITY, EFFORT.

RETURN ONLY JSON:
{
  "recommendations": [
    {
      "text": "string",
      "why": "string",
      "how": "string",
      "impact": <number>,
      "realWorldBenefit": "string",
      "priority": "critical|high|medium",
      "effort": "low|medium|high",
      "category": "technical|craft|graaf"
    }
  ]
}`;

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 3000,
            messages: [{ role: "user", content: prompt }]
          })
        });

        if (!response.ok) throw new Error(`Claude API error: ${response.status}`);

        const apiData = await response.json();
        const text = apiData.content[0].text;
        const cleanText = text.replace(/```json\n?|\n?```/g, '').trim();
        const result = JSON.parse(cleanText);
        
        return result.recommendations;
        
      } catch (error) {
        console.error('Claude recommendations failed:', error);
        return generateDeterministicRecommendations(data);
      }
    }

    function generateDeterministicRecommendations(data) {
      const recs = [];
      const breakdown = data.breakdown || {};
      const audit = data.audit || {};
      const validation = data.validation || {};
      
      // Check if we have detailed breakdown with audit data
      const hasDetailedBreakdown = breakdown.technical?.schemaMarkup !== undefined;
      const hasAuditData = audit && Object.keys(audit).length > 5;
      
      console.log('Generating recommendations:', {
        hasDetailedBreakdown,
        hasAuditData,
        auditKeys: Object.keys(audit).length
      });
      
      if (hasDetailedBreakdown && hasAuditData) {
        // DETAILED RECOMMENDATIONS based on ACTUAL audit data
        
        // 1. Schema markup - check actual schema
        const schemaScore = breakdown.technical?.schemaMarkup || 0;
        const hasSchema = audit.schemaTypes && audit.schemaTypes.length > 0;
        if (schemaScore < 4 || !hasSchema) {
          const missingSchemas = [];
          if (!hasSchema || !audit.schemaTypes.includes('Article')) {
            missingSchemas.push('Article');
          }
          if (!hasSchema || !audit.schemaTypes.includes('FAQPage')) {
            missingSchemas.push('FAQPage');
          }
          
          if (missingSchemas.length > 0) {
            recs.push({
              text: `Add ${missingSchemas.join(' + ')} schema markup (JSON-LD)`,
              why: "67% of searches show AI Overviews. Without schema, your content is invisible to AI systems. This is THE most critical technical fix.",
              how: `Missing: ${missingSchemas.join(', ')}\n\n1. Go to schema.org for templates\n2. Add Article schema with headline, author, datePublished\n3. Add FAQPage schema for Q&A sections\n4. Insert JSON-LD in <head> section\n5. Test with Google Rich Results Validator`,
              impact: 4 - schemaScore,
              realWorldBenefit: "Appear in AI Overviews, Featured Snippets, Knowledge Panels",
              priority: "critical",
              effort: "low",
              category: "technical"
            });
          }
        }
        
        // 2. FAQ - check actual FAQ quality
        const faqScore = breakdown.craft?.faqIntegration || 0;
        const faqCount = audit.faqCount || 0;
        const faqAvgWords = audit.faqAvgWords || 0;
        
        if (faqCount === 0) {
          // No FAQ at all
          recs.push({
            text: "Create FAQ section (currently missing)",
            why: "FAQ sections are GOLD for AI Overviews. Articles with FAQ get 2x more featured snippets. You have NO FAQ section detected.",
            how: "1. Research 'People Also Ask' for your topic\n2. Create 5-10 common questions\n3. Write 100-150 word answers with examples\n4. Add FAQPage schema markup\n5. Place FAQ near end of article",
            impact: 4 - faqScore,
            realWorldBenefit: "2x higher Featured Snippet chance + AI citations",
            priority: "critical",
            effort: "medium",
            category: "craft"
          });
        } else if (faqAvgWords < 100 && faqScore < 4) {
          // FAQ exists but answers too short
          recs.push({
            text: `Expand FAQ answers - currently ${faqCount} questions averaging ${faqAvgWords} words`,
            why: `You have ${faqCount} FAQs but answers are too short (${faqAvgWords} words avg). AI Overviews prefer 100+ word answers with examples and sources.`,
            how: "1. Review each FAQ answer\n2. Add specific examples\n3. Include statistics with sources\n4. Aim for 100-150 words per answer\n5. Add 'According to [source]...' citations",
            impact: 4 - faqScore,
            realWorldBenefit: "Higher AI Overview citation rate",
            priority: "high",
            effort: "medium",
            category: "craft"
          });
        }
        
        // 3. Meta tags - check actual lengths
        const metaScore = breakdown.technical?.metaOptimization || 0;
        const titleLength = audit.metaTitleLength || 0;
        const descLength = audit.metaDescLength || 0;
        
        if (metaScore < 4) {
          const issues = [];
          if (titleLength < 50 || titleLength > 60) {
            issues.push(`Title: ${titleLength} chars (should be 50-60)`);
          }
          if (descLength < 150 || descLength > 160) {
            issues.push(`Description: ${descLength} chars (should be 150-160)`);
          }
          
          if (issues.length > 0) {
            recs.push({
              text: "Optimize meta tags",
              why: "Meta tags improve CTR by 20-30%. Your current tags need adjustment:\n" + issues.join('\n'),
              how: `Current:\n- Title: ${titleLength} chars\n- Description: ${descLength} chars\n\nFix:\n- Title: Keep 50-60 chars, keyword in first 30\n- Description: Write 150-160 chars with CTA`,
              impact: 4 - metaScore,
              realWorldBenefit: "+20-30% more clicks from search results",
              priority: "high",
              effort: "low",
              category: "technical"
            });
          }
        }
        
        // 4. Images & Alt texts - check actual counts
        const mobileScore = breakdown.technical?.mobileOptimization || 0;
        const imageCount = audit.images || 0;
        const altTextCount = audit.altTexts || 0;
        const missingAlts = Math.max(0, imageCount - altTextCount);
        
        if (missingAlts > 0 && mobileScore < 4) {
          recs.push({
            text: `Add alt texts to ${missingAlts} images (${imageCount} total, ${altTextCount} have alt)`,
            why: `You have ${imageCount} images but ${missingAlts} are missing alt texts. This hurts accessibility, SEO, and mobile rankings.`,
            how: "1. Review each image without alt text\n2. Describe what's in the image (10-15 words)\n3. Include target keyword naturally\n4. Be specific, not generic\n5. Skip alt for decorative images",
            impact: Math.min(4, Math.ceil(missingAlts / 2)),
            realWorldBenefit: "Better mobile rankings + image search visibility",
            priority: "high",
            effort: "low",
            category: "technical"
          });
        }
        
        // 5. Visuals - check if enough
        const visualsScore = breakdown.craft?.addVisuals || 0;
        const wordCount = audit.wordCount || 0;
        const expectedImages = Math.ceil(wordCount / 300); // 1 per 300 words
        
        if (imageCount < expectedImages && visualsScore < 6) {
          recs.push({
            text: `Add more visuals - ${imageCount} images for ${wordCount} words (recommend ${expectedImages})`,
            why: `Your article has ${wordCount} words but only ${imageCount} images. Aim for 1 image per 300 words. Content with visuals gets 94% more views.`,
            how: "1. Add images every 300-400 words\n2. Create data tables for statistics\n3. Add infographic for key concepts\n4. Include screenshots if tutorial\n5. Optimize all images (compress, add alt)",
            impact: 6 - visualsScore,
            realWorldBenefit: "+94% more views, better engagement",
            priority: "high",
            effort: "medium",
            category: "craft"
          });
        }
        
        // 6. Expert quotes - check actual count
        const credibilityScore = breakdown.graaf?.credibility || 0;
        const expertQuotes = audit.expertQuotes || 0;
        const statistics = audit.statistics || 0;
        const sources = audit.sources || 0;
        
        if (expertQuotes < 3 && credibilityScore < 8) {
          recs.push({
            text: `Add expert quotes - currently ${expertQuotes} detected`,
            why: `Only ${expertQuotes} expert quotes found. Articles with 3+ expert quotes rank 40% higher through E-E-A-T signals.`,
            how: "1. Find 2-3 industry experts to quote\n2. Include: 'According to [Name], [Title] at [Org]...'\n3. Use recent quotes (2023-2025)\n4. Link to original source\n5. Add actual credentials (PhD, 20 years experience, etc.)",
            impact: Math.min(3, 8 - credibilityScore),
            realWorldBenefit: "+40% better rankings through E-E-A-T",
            priority: "high",
            effort: "medium",
            category: "graaf"
          });
        }
        
        // 7. Statistics & sources
        if (statistics < 5 || sources < 3) {
          recs.push({
            text: `Add more data: ${statistics} statistics, ${sources} cited sources`,
            why: `Current: ${statistics} statistics, ${sources} sources. Articles with 5+ statistics and 3+ sources rank significantly better.`,
            how: "1. Find recent industry reports (2023-2025)\n2. Add specific numbers: '47% of companies...'\n3. Cite source: 'According to [Report Name]...'\n4. Link to original research\n5. Prefer .edu, .gov, industry leaders",
            impact: 2,
            realWorldBenefit: "Build authority and trust signals",
            priority: "medium",
            effort: "medium",
            category: "graaf"
          });
        }
        
        // 8. Table of contents - check if article is long enough
        const tocPresent = audit.tocPresent || 0;
        if (wordCount > 1500 && tocPresent === 0) {
          recs.push({
            text: "Add table of contents (article is long enough)",
            why: `Your article has ${wordCount} words but no TOC. Articles over 1500 words need TOC for better UX and Google loves clear structure.`,
            how: "1. Add TOC at the beginning (after intro)\n2. Link to each H2 heading\n3. Use jump links (#heading-name)\n4. Keep it simple and scannable\n5. Consider making it sticky on desktop",
            impact: 1,
            realWorldBenefit: "Better UX, lower bounce rate, clearer structure",
            priority: "medium",
            effort: "low",
            category: "craft"
          });
        }
        
        // 9. Internal links
        const linkingScore = breakdown.technical?.internalLinking || 0;
        const internalLinks = audit.internalLinks || 0;
        if (internalLinks < 3 && linkingScore < 4) {
          recs.push({
            text: `Add internal links - currently ${internalLinks} detected`,
            why: `Only ${internalLinks} internal links found. Articles with 3-5 internal links rank 40% better through better site structure.`,
            how: "1. Link to related articles\n2. Use descriptive anchor text\n3. Link to pillar content\n4. Aim for 3-5 contextual links\n5. Link naturally within content",
            impact: 4 - linkingScore,
            realWorldBenefit: "Better rankings + distribute page authority",
            priority: "medium",
            effort: "low",
            category: "technical"
          });
        }
        
      } else {
        // FALLBACK: Generic recommendations when no detailed data
        console.warn('No detailed audit data - using generic recommendations');
        
        const technicalTotal = breakdown.technical?.total || 0;
        const craftTotal = breakdown.craft?.total || 0;
        const graafTotal = breakdown.graaf?.total || 0;
        
        if (technicalTotal < 16) {
          recs.push({
            text: "Improve Technical SEO (needs fresh scan for specifics)",
            why: "Technical SEO score is low. Run a fresh scan (not cached) to see specific missing elements like schema, meta tags, mobile issues.",
            how: "For detailed audit:\n1. Click scan again (forces fresh scan)\n2. System will analyze 100+ metrics\n3. You'll get specific recommendations\n4. Based on what's actually missing",
            impact: Math.min(8, 20 - technicalTotal),
            realWorldBenefit: "Get specific actionable fixes",
            priority: "critical",
            effort: "low",
            category: "technical"
          });
        }
        
        if (craftTotal < 24) {
          recs.push({
            text: "Enhance Content Quality (needs fresh scan for specifics)",
            why: "Content quality score is low. Fresh scan will show exact issues: FAQ quality, visual count, readability metrics.",
            how: "Run fresh scan to see:\n- Exact FAQ count and quality\n- Image count vs word count\n- Actual readability metrics\n- Missing content elements",
            impact: Math.min(6, 30 - craftTotal),
            realWorldBenefit: "Know exactly what to fix",
            priority: "high",
            effort: "medium",
            category: "craft"
          });
        }
      }
      
      // If no recommendations, content is excellent
      if (recs.length === 0) {
        recs.push({
          text: "Excellent! Content is well-optimized",
          why: "Your content scores high across all frameworks. All major optimization opportunities have been addressed.",
          how: "Maintenance:\n1. Update statistics quarterly\n2. Refresh content every 6 months\n3. Monitor search rankings\n4. Keep FAQ answers current\n5. Add new expert quotes periodically",
          impact: 0,
          realWorldBenefit: "Maintain top rankings",
          priority: "medium",
          effort: "low",
          category: "maintenance"
        });
      }
      
      return recs;
    }
      
      if (hasDetailedBreakdown) {
        // DETAILED RECOMMENDATIONS
        
        // Schema markup
        if ((breakdown.technical?.schemaMarkup || 0) < 4) {
          recs.push({
            text: "Add Article + FAQPage schema markup (JSON-LD)",
            why: "67% of searches show AI Overviews. Without schema, your content is invisible to AI.",
            how: "1. Copy Article schema template\n2. Fill in your details\n3. Add FAQPage schema\n4. Paste into <head>\n5. Validate with schema.org",
            impact: 4 - (breakdown.technical?.schemaMarkup || 0),
            realWorldBenefit: "Appear in AI Overviews, Featured Snippets",
            priority: "critical",
            effort: "low",
            category: "technical"
          });
        }
        
        // FAQ quality
        if ((breakdown.craft?.faqIntegration || 0) < 4 && (audit.faqCount || 0) > 0) {
          recs.push({
            text: `Expand FAQ answers to 100+ words (currently ${audit.faqAvgWords || 'unknown'} avg)`,
            why: "AI Overviews prefer detailed answers. Short answers (<100 words) are rarely cited.",
            how: "1. Review each FAQ\n2. Add examples\n3. Include statistics\n4. Link to sources\n5. Aim for 100-150 words",
            impact: 4 - (breakdown.craft?.faqIntegration || 0),
            realWorldBenefit: "Higher AI Overview citation rate",
            priority: "high",
            effort: "medium",
            category: "craft"
          });
        }
        
        // Meta optimization
        if ((breakdown.technical?.metaOptimization || 0) < 4) {
          recs.push({
            text: "Optimize meta title and description",
            why: "Meta tags improve CTR by 20-30%.",
            how: `Title: 50-60 chars (current: ${audit.metaTitleLength || 'unknown'})\nDescription: 150-160 chars (current: ${audit.metaDescLength || 'unknown'})`,
            impact: 4 - (breakdown.technical?.metaOptimization || 0),
            realWorldBenefit: "+20-30% click-through rate",
            priority: "high",
            effort: "low",
            category: "technical"
          });
        }
        
      } else {
        // SIMPLIFIED RECOMMENDATIONS (when only totals available)
        // Generate 6-8 specific recommendations based on what's missing
        
        const technicalTotal = breakdown.technical?.total || 0;
        const craftTotal = breakdown.craft?.total || 0;
        const graafTotal = breakdown.graaf?.total || 0;
        
        // TECHNICAL SEO - Break down into specific items
        if (technicalTotal < 20) {
          // Schema Markup (most impactful)
          recs.push({
            text: "Add Article + FAQPage schema markup (JSON-LD)",
            why: "67% of searches now show AI Overviews. Without schema markup, your content is invisible to AI systems. This is THE most critical technical fix.",
            how: "1. Go to schema.org/Article for template\n2. Fill in: headline, author, datePublished, description\n3. Add FAQPage schema for all Q&A content\n4. Insert JSON-LD in <head> section\n5. Test with Google Rich Results Validator",
            impact: 4,
            realWorldBenefit: "Appear in AI Overviews, Featured Snippets, Knowledge Panels",
            priority: "critical",
            effort: "low",
            category: "technical"
          });
          
          // Meta Tags
          if (technicalTotal < 18) {
            recs.push({
              text: "Optimize meta title and description",
              why: "Meta tags are your content's 'ad' in search results. Well-optimized tags can improve click-through rate by 20-30%.",
              how: "Meta Title:\n- Keep 50-60 characters\n- Include main keyword in first 30 chars\n- Add brand at end (if space)\n\nMeta Description:\n- Write 150-160 characters\n- Include main keyword naturally\n- Add clear call-to-action\n- Make it compelling!",
              impact: 2,
              realWorldBenefit: "+20-30% more clicks from search results",
              priority: "high",
              effort: "low",
              category: "technical"
            });
          }
          
          // Mobile Optimization
          if (technicalTotal < 16) {
            recs.push({
              text: "Improve mobile optimization and image alt texts",
              why: "60% of searches happen on mobile. Missing alt texts hurt accessibility, SEO, and mobile image search rankings.",
              how: "Mobile:\n- Test with Google Mobile-Friendly Test\n- Ensure text is readable without zooming\n- Make buttons/links easy to tap (44px min)\n\nAlt Texts:\n- Describe what's actually in the image\n- Include target keyword naturally\n- Keep 10-15 words\n- Be specific, not generic",
              impact: 2,
              realWorldBenefit: "Better mobile rankings + image search visibility",
              priority: "high",
              effort: "low",
              category: "technical"
            });
          }
          
          // Internal Linking
          if (technicalTotal < 14) {
            recs.push({
              text: "Add contextual internal links",
              why: "Internal links help Google understand your site structure and distribute ranking power. Pages with 3+ internal links rank 40% better.",
              how: "1. Identify your pillar content (most important pages)\n2. Link to them from related articles\n3. Use descriptive anchor text (not 'click here')\n4. Aim for 3-5 internal links per article\n5. Link to both older and newer content",
              impact: 2,
              realWorldBenefit: "Better site structure + distribute ranking power",
              priority: "medium",
              effort: "low",
              category: "technical"
            });
          }
        }
        
        // CRAFT FRAMEWORK - Specific content improvements
        if (craftTotal < 30) {
          // FAQ Section
          if (craftTotal < 26) {
            recs.push({
              text: "Create or expand FAQ section with detailed answers",
              why: "FAQ sections are GOLD for AI Overviews. Google loves Q&A format. Articles with FAQ sections get 2x more featured snippet appearances.",
              how: "1. Research 'People Also Ask' questions for your topic\n2. Write 100-150 word answers for each question\n3. Include statistics, examples, and sources\n4. Add FAQPage schema markup\n5. Place FAQ near the end of article",
              impact: 4,
              realWorldBenefit: "2x higher chance of Featured Snippets + AI Overview citations",
              priority: "high",
              effort: "medium",
              category: "craft"
            });
          }
          
          // Visual Content
          if (craftTotal < 24) {
            recs.push({
              text: "Add more visual content (images, infographics, tables)",
              why: "Content with visuals gets 94% more views. Tables make data scannable. Infographics are shared 3x more than text.",
              how: "1. Add 1 image per 300 words minimum\n2. Create data tables for statistics/comparisons\n3. Design simple infographic for key concepts\n4. Add screenshots for tutorials\n5. Use original images when possible\n6. Optimize all images (compress, add alt text)",
              impact: 3,
              realWorldBenefit: "+94% more views, better engagement, lower bounce rate",
              priority: "high",
              effort: "medium",
              category: "craft"
            });
          }
          
          // Readability
          if (craftTotal < 22) {
            recs.push({
              text: "Improve readability and content structure",
              why: "Users scan, they don't read. Well-structured content keeps readers engaged 2x longer. Clear structure signals quality to Google.",
              how: "1. Break paragraphs into 2-4 sentences max\n2. Add clear subheadings (H2, H3) every 200-300 words\n3. Use bullet points for lists\n4. Add table of contents for long articles\n5. Highlight key takeaways in callout boxes\n6. Use simple language (avoid jargon)",
              impact: 2,
              realWorldBenefit: "2x longer time on page, lower bounce rate",
              priority: "medium",
              effort: "low",
              category: "craft"
            });
          }
        }
        
        // GRAAF FRAMEWORK - Authority & Trust
        if (graafTotal < 45) {
          // Expert Quotes & Sources
          recs.push({
            text: "Add expert quotes and cite authoritative sources",
            why: "E-E-A-T (Experience, Expertise, Authority, Trust) is Google's #1 quality signal. Content with expert quotes ranks 40% higher.",
            how: "1. Find 2-3 industry experts to quote\n2. Include their full name, title, and organization\n3. Link to original source if quoting research\n4. Add 'According to [Expert Name], [Title]...'\n5. Include recent statistics (2023-2025) with sources\n6. Link to .edu, .gov, or reputable industry sites",
            impact: 3,
            realWorldBenefit: "40% better rankings + build E-E-A-T score",
            priority: "high",
            effort: "medium",
            category: "graaf"
          });
          
          // Author Bio & Credentials
          if (graafTotal < 42) {
            recs.push({
              text: "Add comprehensive author bio with credentials",
              why: "Google wants to know WHO wrote the content. Author expertise directly impacts E-E-A-T. Articles with author bios rank 15% higher.",
              how: "1. Add author name at top of article\n2. Include professional photo\n3. Write 100-word bio highlighting:\n   - Relevant experience/years in field\n   - Credentials, certifications, degrees\n   - Previous publications or achievements\n4. Link to author's LinkedIn or website\n5. Add Author schema markup",
              impact: 2,
              realWorldBenefit: "+15% better rankings through E-E-A-T",
              priority: "medium",
              effort: "low",
              category: "graaf"
          });
          }
          
          // Content Freshness
          if (graafTotal < 40) {
            recs.push({
              text: "Update content with recent data and current year mentions",
              why: "Google favors fresh content. Adding recent statistics and updating the publish date can boost rankings by 25%.",
              how: "1. Replace old statistics with 2024-2025 data\n2. Add 'Updated: [Current Month Year]' at top\n3. Mention current year in intro paragraph\n4. Update examples to recent events\n5. Remove outdated information\n6. Add section on latest trends/developments",
              impact: 2,
              realWorldBenefit: "+25% ranking boost through freshness signal",
              priority: "medium",
              effort: "low",
              category: "graaf"
            });
          }
        }
      }
      
      // If no recommendations yet, add generic one
      if (recs.length === 0) {
        recs.push({
          text: "Content is well-optimized! Focus on maintaining quality",
          why: "Your content scores high across all frameworks. Continue monitoring and updating.",
          how: "1. Update statistics quarterly\n2. Refresh content every 6 months\n3. Monitor search performance\n4. Keep FAQ answers current",
          impact: 0,
          realWorldBenefit: "Maintain rankings and stay ahead of competitors",
          priority: "medium",
          effort: "low",
          category: "maintenance"
        });
      }
      
      return recs;
    }

    // ============================================================================
    // MAIN SCAN FUNCTION
    // ============================================================================
    
    async function scanURL() {
      const url = document.getElementById('urlInput').value.trim();
      
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('Please enter a valid URL (must start with http:// or https://)');
        return;
      }
      
      document.getElementById('loadingIndicator').classList.remove('hidden');
      document.getElementById('resultsContainer').classList.add('hidden');
      document.getElementById('loadingText').textContent = 'Scanning content...';
      
      try {
        document.getElementById('loadingText').textContent = 'Analyzing content (Layer 1: Backend)...';
        
        // FIX: Use POST with JSON body (not GET with query params)
        const response = await fetch(CONFIG.scanEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url: url })
        });
        
        if (!response.ok) {
          let errorMessage = '';
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorData.message || response.statusText;
          } catch (e) {
            errorMessage = response.statusText || 'Unknown error';
          }
          
          throw new Error(`Scan failed (${response.status}): ${errorMessage}`);
        }
        
        const data = await response.json();
        
        // Handle both response structures
        let scanData;
        if (data.scan) {
          // /api/scan returns: { success: true, scan: {...} }
          scanData = {
            url: data.scan.url,
            score: data.scan.v52_score,
            quality: data.scan.quality,
            breakdown: data.scan.breakdown,
            wordCount: data.scan.wordCount,
            timestamp: data.scan.scanned_at
          };
        } else if (data.success && data.url) {
          // /api/scan-free returns direct result (perfect format!)
          scanData = data;
          
          // Show cache status
          if (data.cached) {
            console.log('‚úÖ Using cached result for consistency');
            document.getElementById('loadingText').textContent = 
              '‚úÖ Using cached result (consistent scoring)...';
            await new Promise(r => setTimeout(r, 800)); // Brief pause to show message
          }
        } else {
          throw new Error('Invalid response structure from backend');
        }
        
        window.lastScanData = scanData;
        
        document.getElementById('loadingText').textContent = 'Calculating potential (Layer 2: Formulas)...';
        const deterministicResult = calculateDeterministicPotential(scanData);
        
        let validation;
        if (CONFIG.claudeEnabled) {
          document.getElementById('loadingText').textContent = 'Validating with AI (Layer 3: Claude)...';
          validation = await validateWithClaude(deterministicResult, scanData);
        } else {
          validation = {
            validated: deterministicResult.potential,
            adjustments: [],
            edgeCases: [],
            usedClaude: false
          };
        }
        
        let recommendations;
        if (CONFIG.claudeEnabled) {
          document.getElementById('loadingText').textContent = 'Generating recommendations (Layer 4: Claude)...';
          recommendations = await generateRecommendationsWithClaude(scanData, validation);
        } else {
          recommendations = generateDeterministicRecommendations(scanData);
        }
        
        displayResults({ ...scanData, deterministicResult, validation, recommendations });
        
      } catch (error) {
        console.error('Scan error:', error);
        alert(`Scan failed:\n\n${error.message}\n\nCheck browser console for details.`);
      } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
      }
    }

    // ============================================================================
    // DISPLAY RESULTS
    // ============================================================================
    
    function displayResults(data) {
      const { deterministicResult, validation, recommendations } = data;
      
      document.getElementById('resultsContainer').classList.remove('hidden');
      document.getElementById('currentScore').textContent = Math.round(data.score);
      document.getElementById('deterministicPotential').textContent = deterministicResult.potential;
      
      const validatedScore = validation.validated || deterministicResult.potential;
      document.getElementById('validatedPotential').textContent = validatedScore;
      
      const validationStatus = document.getElementById('validationStatus');
      if (CONFIG.claudeEnabled && validation.usedClaude) {
        const diff = validatedScore - deterministicResult.potential;
        if (diff !== 0) {
          validationStatus.innerHTML = `
            <div class="mt-3 p-3 bg-purple-900 bg-opacity-50 rounded-lg border border-purple-500">
              <div class="flex items-center gap-2">
                <span class="text-purple-400">ü§ñ AI Adjustment:</span>
                <span class="text-white font-semibold">${diff > 0 ? '+' : ''}${diff} points</span>
                <span class="text-gray-400 text-sm">(${deterministicResult.potential} ‚Üí ${validatedScore})</span>
              </div>
            </div>
          `;
          validationStatus.classList.remove('hidden');
        } else {
          validationStatus.innerHTML = `
            <div class="mt-3 p-3 bg-green-900 bg-opacity-30 rounded-lg border border-green-500">
              <div class="text-green-400 text-sm">‚úÖ AI validation confirms deterministic calculation</div>
            </div>
          `;
          validationStatus.classList.remove('hidden');
        }
      } else {
        validationStatus.classList.add('hidden');
      }
      
      const targetMsg = document.getElementById('targetMessage');
      if (validatedScore >= 95) {
        targetMsg.innerHTML = `<div class="text-green-400 font-semibold">‚úÖ Excellent! Target of 95+ is achievable with these fixes!</div>`;
      } else if (validatedScore >= 90) {
        targetMsg.innerHTML = `<div class="text-yellow-400 font-semibold">‚ö†Ô∏è Close! To reach 95+, focus on content quality improvements.</div>`;
      } else {
        targetMsg.innerHTML = `<div class="text-blue-400">üìä Focus on quick wins first (+${validatedScore - Math.round(data.score)} points), then reassess.</div>`;
      }
      
      displayScoreBreakdown(data);
      
      if (CONFIG.claudeEnabled && validation.usedClaude) {
        displayAIInsights(validation);
      } else {
        document.getElementById('aiInsights').classList.add('hidden');
      }
      
      displayRecommendations(recommendations, CONFIG.claudeEnabled);
    }

    function displayScoreBreakdown(data) {
      const breakdown = data.breakdown;
      
      // Check if we have detailed breakdown
      const hasDetailedBreakdown = breakdown.technical?.schemaMarkup !== undefined;
      
      if (!hasDetailedBreakdown) {
        // Show simplified view with note
        const html = `
          <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-yellow-400">‚ÑπÔ∏è</span>
              <span class="font-semibold text-yellow-300">Simplified Breakdown</span>
            </div>
            <div class="text-sm text-gray-300">
              This scan shows total scores only. For detailed sub-scores, the scan needs fresh analysis data.
            </div>
          </div>
          
          <div class="mb-3">
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-lg">üéØ GRAAF Framework:</span>
                <span class="font-bold text-xl">${breakdown.graaf?.total || 0}/50</span>
              </div>
            </div>
            <div class="text-sm text-gray-400 mt-2 px-3">
              Credibility, Relevance, Actionability, Accuracy, Freshness
            </div>
          </div>

          <div class="mb-3">
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-lg">‚ú® CRAFT Framework:</span>
                <span class="font-bold text-xl">${breakdown.craft?.total || 0}/30</span>
              </div>
            </div>
            <div class="text-sm text-gray-400 mt-2 px-3">
              Cut Fluff, Review & Optimize, Add Visuals, FAQ Integration, Trust Building
            </div>
          </div>

          <div class="mb-3">
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-lg">‚öôÔ∏è Technical SEO:</span>
                <span class="font-bold text-xl">${breakdown.technical?.total || 0}/20</span>
              </div>
            </div>
            <div class="text-sm text-gray-400 mt-2 px-3">
              Meta Optimization, Schema Markup, Internal Linking, Page Structure, Mobile
            </div>
          </div>
        `;
        
        document.getElementById('scoreBreakdown').innerHTML = html;
        return;
      }
      
      // Detailed breakdown
      const html = `
        <div class="mb-3">
          <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600" onclick="toggleCalc('graaf-breakdown')">
            <div class="flex items-center gap-3">
              <span class="text-lg">üéØ GRAAF Framework:</span>
              <span class="font-bold text-xl">${breakdown.graaf.total}/50</span>
            </div>
            <span class="text-gray-400 text-sm">Click to expand ‚ñº</span>
          </div>
          <div id="graaf-breakdown" class="calc-breakdown">
            <div class="space-y-2">
              <div>‚Ä¢ Credibility: ${breakdown.graaf.credibility}/10</div>
              <div>‚Ä¢ Relevance: ${breakdown.graaf.relevance}/10</div>
              <div>‚Ä¢ Actionability: ${breakdown.graaf.actionability}/10</div>
              <div>‚Ä¢ Accuracy: ${breakdown.graaf.accuracy}/10</div>
              <div>‚Ä¢ Freshness: ${breakdown.graaf.freshness}/10</div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600" onclick="toggleCalc('craft-breakdown')">
            <div class="flex items-center gap-3">
              <span class="text-lg">‚ú® CRAFT Framework:</span>
              <span class="font-bold text-xl">${breakdown.craft.total}/30</span>
            </div>
            <span class="text-gray-400 text-sm">Click to expand ‚ñº</span>
          </div>
          <div id="craft-breakdown" class="calc-breakdown">
            <div class="space-y-2">
              <div>‚Ä¢ Cut Fluff: ${breakdown.craft.cutFluff}/8</div>
              <div>‚Ä¢ Review & Optimize: ${breakdown.craft.reviewOptimize}/8</div>
              <div>‚Ä¢ Add Visuals: ${breakdown.craft.addVisuals}/6</div>
              <div>‚Ä¢ FAQ Integration: ${breakdown.craft.faqIntegration}/4</div>
              <div>‚Ä¢ Trust Building: ${breakdown.craft.trustBuilding}/4</div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600" onclick="toggleCalc('technical-breakdown')">
            <div class="flex items-center gap-3">
              <span class="text-lg">‚öôÔ∏è Technical SEO:</span>
              <span class="font-bold text-xl">${breakdown.technical.total}/20</span>
            </div>
            <span class="text-gray-400 text-sm">Click to expand ‚ñº</span>
          </div>
          <div id="technical-breakdown" class="calc-breakdown">
            <div class="space-y-2">
              <div>‚Ä¢ Meta Optimization: ${breakdown.technical.metaOptimization}/4</div>
              <div>‚Ä¢ Schema Markup: ${breakdown.technical.schemaMarkup}/4</div>
              <div>‚Ä¢ Internal Linking: ${breakdown.technical.internalLinking}/4</div>
              <div>‚Ä¢ Page Structure: ${breakdown.technical.pageStructure}/4</div>
              <div>‚Ä¢ Mobile Optimization: ${breakdown.technical.mobileOptimization}/4</div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('scoreBreakdown').innerHTML = html;
    }

    function displayAIInsights(validation) {
      const aiInsights = document.getElementById('aiInsights');
      
      if (validation.adjustments && validation.adjustments.length > 0) {
        const adjustmentsList = validation.adjustments.map(adj => `
          <div class="adjustment-card">
            <div class="font-semibold text-gray-900">${adj.category}: ${adj.from} ‚Üí ${adj.to} points</div>
            <div class="text-sm text-gray-700 mt-1">${adj.reason}</div>
          </div>
        `).join('');
        
        document.getElementById('adjustmentsList').innerHTML = adjustmentsList;
        document.getElementById('adjustmentsContainer').classList.remove('hidden');
      } else {
        document.getElementById('adjustmentsContainer').classList.add('hidden');
      }
      
      if (validation.edgeCases && validation.edgeCases.length > 0) {
        const edgeCasesList = validation.edgeCases.map(edge => `
          <div class="edge-case-card">
            <div class="text-sm text-blue-900">${edge}</div>
          </div>
        `).join('');
        
        document.getElementById('edgeCasesList').innerHTML = edgeCasesList;
        document.getElementById('edgeCasesContainer').classList.remove('hidden');
      } else {
        document.getElementById('edgeCasesContainer').classList.add('hidden');
      }
      
      aiInsights.classList.remove('hidden');
    }

    function displayRecommendations(recommendations, usedClaude) {
      const priorityOrder = { critical: 1, high: 2, medium: 3 };
      const sortedRecs = recommendations.sort((a, b) => 
        priorityOrder[a.priority] - priorityOrder[b.priority]
      );
      
      const html = sortedRecs.map((rec, idx) => {
        const priorityColors = {
          critical: 'bg-red-900 border-red-500',
          high: 'bg-orange-900 border-orange-500',
          medium: 'bg-blue-900 border-blue-500'
        };
        
        const effortBadges = {
          low: '<span class="px-2 py-1 bg-green-600 text-white rounded text-xs">‚ö° 15 min</span>',
          medium: '<span class="px-2 py-1 bg-yellow-600 text-white rounded text-xs">‚è±Ô∏è 1-2 hrs</span>',
          high: '<span class="px-2 py-1 bg-red-600 text-white rounded text-xs">üî• 4+ hrs</span>'
        };
        
        return `
          <div class="recommendation bg-gray-800 rounded-lg p-5 mb-4 border-l-4 ${priorityColors[rec.priority]}">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-bold text-lg flex-1">${idx + 1}. ${rec.text}</h4>
              <div class="flex items-center gap-2">
                ${effortBadges[rec.effort]}
                <span class="px-3 py-1 bg-purple-600 text-white rounded-full text-sm font-semibold">+${rec.impact} pts</span>
              </div>
            </div>
            
            ${usedClaude ? `
              <div class="space-y-3 text-sm">
                <div>
                  <div class="text-gray-400 font-semibold mb-1">üí° Why This Matters:</div>
                  <div class="text-gray-300">${rec.why}</div>
                </div>
                
                <div>
                  <div class="text-gray-400 font-semibold mb-1">üîß How to Implement:</div>
                  <div class="text-gray-300 whitespace-pre-line">${rec.how}</div>
                </div>
                
                <div>
                  <div class="text-gray-400 font-semibold mb-1">üìà Real-World Benefit:</div>
                  <div class="text-gray-300">${rec.realWorldBenefit}</div>
                </div>
              </div>
            ` : `
              <div class="text-sm text-gray-400">
                Enable AI mode for detailed WHY, HOW, and real-world benefits
              </div>
            `}
          </div>
        `;
      }).join('');
      
      document.getElementById('recommendationsContainer').innerHTML = html;
    }

    function toggleCalc(id) {
      const el = document.getElementById(id);
      el.classList.toggle('open');
    }
  </script>
</body>
</html>
